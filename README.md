# Удаление сообщений в Yandex 360

## Обзор

Скрипт `del_message.py` предназначен для поиска и удаления электронных писем в почтовых ящиках Yandex 360 на основе идентификатора сообщения (`Message-ID`) и даты. Скрипт взаимодействует с API Yandex 360 для получения логов аудита и использует IMAP для доступа к почтовым ящикам. Он поддерживает интерактивный интерфейс для ввода параметров поиска, работу с логами аудита для определения почтовых ящиков и режим "сухого прогона" (`dry_run`) для тестирования без фактического удаления сообщений.

## Функциональность

1. **Конфигурация**:
   - Загружает настройки из переменных окружения или файла `.env` (OAuth-токен, ID организации, параметры приложения, имена файлов).
   - Поддерживает аргументы командной строки для указания `Message-ID` и даты сообщения.
   - Проверяет валидность входных параметров (email-адреса, даты, целочисленные значения).

2. **Интерактивное меню**:
   - Позволяет вручную задавать параметры поиска: `Message-ID`, дату сообщения, диапазон дней для поиска (± от указанной даты), список почтовых ящиков.
   - Поддерживает очистку параметров поиска и загрузку данных из файлов (хотя функциональность загрузки из файлов закомментирована).

3. **Поиск почтовых ящиков**:
   - Если выбран режим использования логов аудита, запрашивает логи через API Yandex 360 для определения почтовых ящиков, содержащих сообщение с указанным `Message-ID`.
   - Позволяет вручную указать список почтовых ящиков для поиска.

4. **Поиск и удаление сообщений**:
   - Подключается к IMAP-серверу Yandex (`imap.yandex.ru`) для каждого почтового ящика.
   - Выполняет поиск сообщений по критериям: дата (± указанный диапазон дней) и `Message-ID`.
   - Удаляет найденные сообщения (или имитирует удаление в режиме `dry_run`).
   - Логирует результаты операций (удаление или отсутствие сообщений).

5. **Логирование**:
   - Логирует операции в консоль (уровень INFO) и в ротируемый файл `delete_messages.log` (уровень DEBUG).
   - Ротация файла происходит при достижении 1 МБ, сохраняется до 5 резервных копий.

## Параметры

Скрипт использует следующие переменные окружения, которые можно задать в файле `.env` в каталоге скрипта или непосредственно в окружении:

| Имя параметра                          | Описание                                                                 | Обязательный | Пример значения                   |
|----------------------------------------|--------------------------------------------------------------------------|--------------|-----------------------------------|
| `OAUTH_TOKEN_ARG`                      | OAuth-токен для аутентификации в API Yandex 360.                         | Да           | `y0_AgAAAA...`                   |
| `ORGANIZATION_ID_ARG`                  | Идентификатор организации в Yandex 360 (целочисленный).                  | Да           | `123456`                          |
| `APPLICATION_CLIENT_ID_ARG`            | Client ID веб-приложения для получения пользовательских токенов.         | Да           | `abc123...`                       |
| `APPLICATION_CLIENT_SECRET_ARG`        | Client Secret веб-приложения для получения пользовательских токенов.     | Да           | `xyz789...`                       |
| `MESSAGE_ID_FILE_NAME`                 | Имя файла с `Message-ID` для поиска (не используется в текущей версии).  | Нет          | `message_ids.csv`                 |
| `MAILBOXES_TO_SEARCH_FILE_NAME`        | Имя файла со списком почтовых ящиков (не используется в текущей версии). | Нет          | `mailboxes.csv`                   |
| `DRY_RUN`                              | Режим "сухого прогона" (`true` для имитации удаления, `false` для реального). | Нет (по умолчанию `false`) | `true` или `false` |

### Аргументы командной строки
| Аргумент   | Описание                                           | Обязательный | Пример значения           |
|------------|----------------------------------------------------|--------------|---------------------------|
| `--id`     | `Message-ID` для поиска сообщения.                 | Нет          | `<123@domain.com>`        |
| `--date`   | Дата сообщения в формате `DD-MM-YYYY`.             | Нет          | `01-10-2023`              |

### Примечания к параметрам
- **Переменные окружения**: Все обязательные параметры (`OAUTH_TOKEN_ARG`, `ORGANIZATION_ID_ARG`, `APPLICATION_CLIENT_ID_ARG`, `APPLICATION_CLIENT_SECRET_ARG`) должны быть заданы. При их отсутствии скрипт завершится с кодом `1`.
- **Формат даты**: Поддерживаются форматы `DD-MM-YYYY`, `DD.MM.YYYY`, `DD/MM/YYYY`, `YYYY-MM-DD`, `YYYY/MM/DD`, `MM/DD/YYYY`, `DD-MM-YY`, `YYYY.MM.DD`, а также текстовые форматы на английском (например, `25 December 2023`).
- **DRY_RUN**: Если `DRY_RUN=true`, скрипт только имитирует удаление, логируя действия без фактического изменения почтовых ящиков.
- **Файл `.env`**: Пример файла `.env`:
  ```
  OAUTH_TOKEN_ARG=y0_AgAAAA...
  ORGANIZATION_ID_ARG=123456
  APPLICATION_CLIENT_ID_ARG=abc123...
  APPLICATION_CLIENT_SECRET_ARG=xyz789...
  MESSAGE_ID_FILE_NAME=message_ids.csv
  MAILBOXES_TO_SEARCH_FILE_NAME=mailboxes.csv
  DRY_RUN=false
  ```
## Подготовка токенов и сервисного приложения для запуска скрипта
> [!WARNING]  
> Настройка сервисного приложения доступна только для учётной записи ВЛАДЕЛЬЦА организации Яндекс 360. Прав администратора для выполнения нижеописанных действий недостаточно!

Скрипт для доступа к содержимому почтового ящика пользователя использует технологию [сервисных приложений в Яндекс 360](https://yandex.ru/support/yandex-360/business/admin/ru/security-service-applications). 
По данной инструкции необходимо:
1. Создать основное OAuth приложение с правами:
    - ya360_security:service_applications_read
    - ya360_security:service_applications_write
2. Сгенерировать для данного приложения токен, который будет использоваться в переменной среды `OAUTH_TOKEN_ARG`. Генерация токена происходит в браузере с обязательной аутентификацией в Яндекс 360 учётной записью владеца организации.
3. Активировать функицонал сервисных приложений с помощью вызова API (используя ранее полученный токен).
4. Создать ёще одно OAuth (сервисное) приложение с правами:
    - mail:imap_ro
    - mail:imap_full
5. Сохранить `ID` сервисного приложения и `Secret` (они будут использоваться в переменных среды `APPLICATION_CLIENT_ID_ARG` и `APPLICATION_CLIENT_SECRET_ARG`).
6. Используя Яндекс 360 API, внести идентификатор нового приложения в список сервисных приложений на уровне системы Яндекс 360.



## Установка

1. **Установите Python**: Требуется Python 3.7 или выше.
2. **Установите зависимости**:
   Скрипт требует следующие Python-пакеты:
   - `python-dotenv`: Для загрузки переменных окружения из `.env`.
   - `requests`: Для HTTP-запросов к API Yandex 360.
   - `python-dateutil`: Для работы с датами.
   - `aioimaplib`: Для асинхронного взаимодействия с IMAP-сервером.

   Установите их с помощью:
   ```bash
   pip install python-dotenv requests python-dateutil aioimaplib
   ```

3. **Настройте окружение**:
   - Создайте файл `.env` в каталоге скрипта с необходимыми параметрами (см. пример выше).
   - Убедитесь, что у вас есть действующий OAuth-токен, ID организации и параметры веб-приложения Yandex 360.

## Запуск

1. **Подготовка**:
   - Поместите скрипт `del_message.py` в рабочий каталог.
   - Создайте и заполните файл `.env` или задайте переменные окружения.

2. **Запуск скрипта**:
   - **С аргументами командной строки**:
     ```bash
     python del_message.py --id "<123@domain.com>" --date "01-10-2023"
     ```
     Это установит начальные параметры и откроет интерактивное меню.
   - **Без аргументов**:
     ```bash
     python del_message.py
     ```
     Откроется интерактивное меню для ввода параметров вручную.

3. **Использование меню**:
   - Выберите опцию в главном меню:
     - `1`: Ввести параметры поиска вручную.
     - `2`: Загрузить параметры из файла (не реализовано в текущей версии).
     - `0`: Выход.
   - В меню ручного ввода параметров:
     - `1`: Указать `Message-ID` и (опционально) дату.
     - `2`: Указать дату сообщения.
     - `3`: Указать диапазон дней для поиска (± от даты).
     - `4`: Указать список почтовых ящиков.
     - `5`: Очистить параметры поиска.
     - `8`: Удалить сообщения, используя логи аудита для поиска почтовых ящиков.
     - `9`: Удалить сообщения без использования логов (требуется заранее заданный список почтовых ящиков).
     - `0`: Вернуться в главное меню.

4. **Пример работы**:
   - Задайте `Message-ID` и дату через меню или аргументы.
   - Укажите почтовые ящики вручную или позвольте скрипту найти их через логи аудита.
   - Выберите опцию удаления (`8` или `9`).
   - Скрипт подключится к IMAP, найдёт сообщения и удалит их (или имитирует удаление в режиме `dry_run`).
   - Результаты логируются в `delete_messages.log` и выводятся в консоль.

## Логирование

- **Консоль**: Сообщения уровня INFO с временными метками (например, `2023-10-01 12:00:00.123 INFO: Поиск почтовых ящиков...`).
- **Файл**: Сообщения уровня DEBUG записываются в `delete_messages.log`, ротация происходит при достижении 1 МБ (хранится 5 резервных копий).
- Формат записей внутри файла логов: `%(asctime)s.%(msecs)03d %(levelname)s:\t%(message)s` с форматом даты `ГГГГ-ММ-ДД ЧЧ:ММ:СС`.

## Обработка ошибок

- **Ошибки конфигурации**: Если отсутствуют обязательные переменные окружения или `ORGANIZATION_ID_ARG` не является целым числом, скрипт завершается с кодом `1`.
- **Ошибки ввода**: Неверные форматы даты или email-адреса отклоняются с сообщениями об ошибке.
- **Ошибки API/IMAP**: Ошибки запросов к API или подключения к IMAP логируются с подробностями (тип ошибки, строка кода).
- **Ограничения**: Поиск по логам аудита невозможен для сообщений старше 90 дней без вручную заданных почтовых ящиков.

## Ограничения

- **Диапазон дат**: Поиск ограничен ±90 днями от указанной даты. Даты старше 20 лет или из будущего отклоняются.
- **Логи аудита**: Для сообщений старше 90 дней требуется вручную задать список почтовых ящиков, так как логи аудита недоступны.
- **Фильтрация**: Ограничивается событиями `message_receive` (`FILTERED_EVENTS`) и пустым списком почтовых ящиков (`FILTERED_MAILBOXES`). Отдельно настраивать данные константы в срипте нет необходимости.
- **Файловый ввод**: Функциональность загрузки `Message-ID` и почтовых ящиков из файлов закомментирована и не используется.

## Лицензия

Проект распространяется под лицензией MIT. Подробности см. в файле `LICENSE`.